<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaveNexus - Multi-Emulator Manager</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/shared-dashboard.css') }}">
</head>
<body>
	<script src="js/script.js" defer></script>
	<div class="backwrap gradient">
	  <div class="back-shapes">
		  <span class="floating circle" style="top:66.59856996935649%;left:13.020833333333334%;animation-delay:-0.9s;"></span>
		  <span class="floating triangle" style="top:31.46067415730337%;left:33.59375%;animation-delay:-4.8s;"></span>
		  <span class="floating cross" style="top:76.50663942798774%;left:38.020833333333336%;animation-delay:-4s;"></span>
		  <span class="floating square" style="top:21.450459652706844%;left:14.0625%;animation-delay:-2.8s;"></span>
		  <span class="floating square" style="top:58.12053115423902%;left:56.770833333333336%;animation-delay:-2.15s;"></span>
		  <span class="floating square" style="top:8.682328907048008%;left:72.70833333333333%;animation-delay:-1.9s;"></span>
		  <span class="floating cross" style="top:31.3585291113381%;left:58.541666666666664%;animation-delay:-0.65s;"></span>
		  <span class="floating cross" style="top:69.96935648621042%;left:81.45833333333333%;animation-delay:-0.4s;"></span>
		  <span class="floating circle" style="top:15.117466802860061%;left:32.34375%;animation-delay:-4.1s;"></span>
		  <span class="floating circle" style="top:13.074565883554648%;left:45.989583333333336%;animation-delay:-3.65s;"></span>
		  <span class="floating cross" style="top:55.87334014300306%;left:27.135416666666668%;animation-delay:-2.25s;"></span>
		  <span class="floating cross" style="top:49.54034729315628%;left:53.75%;animation-delay:-2s;"></span>
		  <span class="floating cross" style="top:34.62717058222676%;left:49.635416666666664%;animation-delay:-1.55s;"></span>
		  <span class="floating cross" style="top:33.19713993871297%;left:86.14583333333333%;animation-delay:-0.95s;"></span>
		  <span class="floating square" style="top:28.19203268641471%;left:25.208333333333332%;animation-delay:-4.45s;"></span>
		  <span class="floating circle" style="top:39.7344228804903%;left:10.833333333333334%;animation-delay:-3.35s;"></span>
		  <span class="floating triangle" style="top:77.83452502553627%;left:24.427083333333332%;animation-delay:-2.3s;"></span>
		  <span class="floating triangle" style="top:2.860061287027579%;left:47.864583333333336%;animation-delay:-1.75s;"></span>
		  <span class="floating triangle" style="top:71.3993871297242%;left:66.45833333333333%;animation-delay:-1.25s;"></span>
		  <span class="floating triangle" style="top:31.256384065372828%;left:76.92708333333333%;animation-delay:-0.65s;"></span>
		  <span class="floating triangle" style="top:46.47599591419816%;left:38.90625%;animation-delay:-0.35s;"></span>
		  <span class="floating cross" style="top:3.4729315628192032%;left:19.635416666666668%;animation-delay:-4.3s;"></span>
		  <span class="floating cross" style="top:3.575076608784474%;left:6.25%;animation-delay:-4.05s;"></span>
		  <span class="floating cross" style="top:77.3237997957099%;left:4.583333333333333%;animation-delay:-3.75s;"></span>
		  <span class="floating cross" style="top:0.9193054136874361%;left:71.14583333333333%;animation-delay:-3.3s;"></span>
		  <span class="floating square" style="top:23.6976506639428%;left:63.28125%;animation-delay:-2.1s;"></span>
		  <span class="floating square" style="top:81.30745658835546%;left:45.15625%;animation-delay:-1.75s;"></span>
		  <span class="floating square" style="top:60.9805924412666%;left:42.239583333333336%;animation-delay:-1.45s;"></span>
		  <span class="floating square" style="top:29.009193054136876%;left:93.90625%;animation-delay:-1.05s;"></span>
		  <span class="floating square" style="top:52.093973442288046%;left:68.90625%;animation-delay:-0.7s;"></span>
		  <span class="floating square" style="top:81.51174668028601%;left:83.59375%;animation-delay:-0.35s;"></span>
		  <span class="floating square" style="top:11.542390194075587%;left:91.51041666666667%;animation-delay:-0.1s;"></span>
	  </div>
	</div>

    <div class="container">
        <header>
            <h1>SaveNexus</h1>
            <p>Multi-Emulator Save Manager</p>
            <div class="status-bar">
                <span id="localAgentStatus" class="status-badge status-offline">Local Agent: Offline</span>
                <span id="totalGames" class="status-badge" style="background:#3b82f6;color:white">0 Total Games</span>
				<a href="/iso-scanner" class="status-badge" style="background: #8b5cf6; color: white; text-decoration: none;">
					üîç ISO Scanner
				</a>
				
            </div>
        </header>

        <div class="tab-container">
            <div class="tab-nav">
                <button class="tab-button active" onclick="switchTab('all')">
                    üéÆ All Games <span class="tab-badge" id="badge-all">0</span>
                </button>
                <button class="tab-button" onclick="switchTab('ppsspp')">
                    üì± PPSSPP <span class="tab-badge" id="badge-ppsspp">0</span>
                </button>
                <button class="tab-button" onclick="switchTab('snes9x')">
                    üéÆ SNES9x <span class="tab-badge" id="badge-snes9x">0</span>
                </button>
                <button class="tab-button" onclick="switchTab('dolphin')">
                    üê¨ Dolphin <span class="tab-badge" id="badge-dolphin">0</span>
                </button>
                <button class="tab-button" onclick="switchTab('citra')">
                    üéÆ Citra <span class="tab-badge" id="badge-citra">0</span>
                </button>
            </div>

            <!-- Tab Contents -->
			<div class="inner-scroller">
            <div id="tab-all" class="tab-content active">
                <div id="loading-all" class="loading">Connecting to local agent...</div>
                <div id="games-all" class="game-grid"></div>
            </div>

            <div id="tab-ppsspp" class="tab-content">
                <div id="loading-ppsspp" class="loading">Loading PPSSPP games...</div>
                <div id="games-ppsspp" class="game-grid"></div>
            </div>

            <div id="tab-snes9x" class="tab-content">
                <div id="loading-snes9x" class="loading">Loading SNES9x games...</div>
                <div id="games-snes9x" class="game-grid"></div>
            </div>

            <div id="tab-dolphin" class="tab-content">
                <div class="coming-soon">
                    <h2>üê¨ Dolphin Emulator</h2>
                    <p>GameCube & Wii support</p>
                    <span class="coming-soon-badge">Coming Soon</span>
                </div>
            </div>

            <div id="tab-citra" class="tab-content">
                <div class="coming-soon">
                    <h2>üéÆ Citra Emulator</h2>
                    <p>Nintendo 3DS support</p>
                    <span class="coming-soon-badge">Coming Soon</span>
                </div>
            </div>
			</div>
			
        </div>
    </div>

    <!-- Launch Modal -->
    <div id="launchModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalGameTitle">Select Save</h2>
            <div id="saveOptions"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeLaunchModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmLaunch()">Launch</button>
            </div>
        </div>
    </div>
	

    <script>
        const API_BASE = 'http://127.0.0.1:8765/api';
        let currentGame = null;
        let selectedSave = null;
        let currentTab = 'all';

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-button').classList.add('active');

            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            currentTab = tabName;
            loadGames(tabName);
        }

        async function checkAgentStatus() {
            try {
                const res = await fetch(`${API_BASE}/status`);
                const data = await res.json();
                const el = document.getElementById('localAgentStatus');
                
                if (data.status === 'online') {
                    el.textContent = 'Emulator: Online';
                    el.className = 'status-badge status-online';
                    loadGames('all');
                } else {
                    el.textContent = 'Emulator: Offline';
                    el.className = 'status-badge status-offline';
                }
            } catch (e) {
                document.getElementById('localAgentStatus').className = 'status-badge status-offline';
            }
        }



		async function loadGames(emulator = 'all') {
			const loadingId = emulator === 'all' ? 'loading-all' : `loading-${emulator}`;
			const gamesId = emulator === 'all' ? 'games-all' : `games-${emulator}`;
			
			const loading = document.getElementById(loadingId);
			const container = document.getElementById(gamesId);
			
			if (!loading || !container) {
				console.error(`[ERROR] Missing elements: loading=${loadingId}, container=${gamesId}`);
				return;
			}
			
			loading.style.display = 'block';
			container.innerHTML = '';
			
			try {
				const url = emulator === 'all' 
					? `${API_BASE}/games`
					: `${API_BASE}/games?emulator=${emulator}`;
				
				console.log(`[DEBUG] Loading games from: ${url}`);
				
				const res = await fetch(url);
				if (!res.ok) throw new Error(`HTTP ${res.status}`);
				
				const data = await res.json();
				
				console.log(`[DEBUG] Received data for ${emulator}:`, data);
				console.log(`[DEBUG] Games count: ${data.games?.length || 0}`);
				console.log(`[DEBUG] By emulator:`, data.by_emulator);
				console.log("[ICON DEBUG] First few games icon paths:");
				data.games?.slice(0,3).forEach(g => {
				console.log(`  ‚Ä¢ ${g.title} (${g.disc_id || g.id}) ‚Üí icon_path =`, g.icon_path);
				});
				
				loading.style.display = 'none';
				
				displayGames(data.games || [], container);
				
				// Update total games counter
				if (document.getElementById('totalGames')) {
					document.getElementById('totalGames').textContent = `${data.total || 0} Total Games`;
				}
				
				// Update tab badges
				const badgeId = `badge-${emulator}`;
				const badge = document.getElementById(badgeId);
				if (badge) {
					badge.textContent = data.games?.length || 0;
				}
				
				// Update all badges if loading 'all'
				if (emulator === 'all' && data.by_emulator) {
					document.getElementById('badge-all').textContent = data.total || 0;
					document.getElementById('badge-ppsspp').textContent = data.by_emulator.ppsspp || 0;
					document.getElementById('badge-snes9x').textContent = data.by_emulator.snes9x || 0;
				}
				
			} catch (e) {
				console.error(`[ERROR] Failed to load ${emulator}:`, e);
				loading.style.display = 'none';
				loading.textContent = 'Failed to load games';
			}
		}

		function displayGames(games, container) {
			if (games.length === 0) {
				container.innerHTML = '<div class="no-games"><h2>No Games Found</h2></div>';
				return;
			}
			
			container.innerHTML = games.map(game => {
				// Handle both disc_id (PSP) and id (SNES)
				const gameId = game.disc_id || game.id;
				const emulator = game.emulator || 'unknown';
				
				console.log(`[DISPLAY] Game: ${game.title}, Emulator: ${emulator}, ID: ${gameId}`);
				
                const iconHtml = game.icon_path 
                    ? `<img src="${API_BASE}/icon/${gameId}" alt="${game.title}" onerror="this.outerHTML='<div class=\\'game-icon\\'>üéÆ</div>'">`
                    : '<div class="game-icon">üéÆ</div>';

				
				const saveStatesHtml = game.save_states && game.save_states.length > 0
					? `<div class="save-states-list">
						${game.save_states.slice(0, 3).map(state => 
							`<div class="save-state-item">‚ö° ${state.filename}</div>`
						).join('')}
					   </div>`
					: '';
				
				// Different status for different emulators
				let statusHtml = '';
				if (emulator === 'ppsspp') {
					statusHtml = game.has_iso 
						? '<span style="color: #10b981;">‚úì ISO Mapped</span>'
						: '<span style="color: #ef4444;">‚úó No ISO</span>';
				} else if (emulator === 'snes9x') {
					statusHtml = game.has_rom 
						? '<span style="color: #10b981;">‚úì ROM Mapped</span>'
						: '<span style="color: #ef4444;">‚úó No ROM</span>';
				}
				
				const canLaunch = game.has_iso || game.has_rom;
				
				return `
					<div class="game-card" data-emulator="${emulator}">
					<div class="game-icon">${iconHtml}</div>
						<div class="game-info">
							<div class="game-title">${game.title}</div>
							<div class="game-disc-id">${gameId} ‚Ä¢ ${statusHtml}</div>
							${saveStatesHtml}
							<button class="launch-button" ${!canLaunch ? 'disabled' : ''} 
									onclick='openLaunchModal(${JSON.stringify(game).replace(/'/g, "&apos;")})'>
								${canLaunch ? 'üéÆ Launch' : '‚ö†Ô∏è No File'}
							</button>
						</div>
					</div>
				`;
			}).join('');
		}


        function openLaunchModal(game) {
            if (!game.has_iso && !game.has_rom) {
                alert('No ISO/ROM mapped for this game');
                return;
            }

            currentGame = game;
            document.getElementById('modalGameTitle').textContent = game.title || 'Game';

            const options = document.getElementById('saveOptions');
            options.innerHTML = '';

            // Main save
            const main = document.createElement('div');
            main.className = 'save-option selected';
            main.onclick = () => selectSave(null, main);
            main.innerHTML = `
                <strong>üíæ Main Save File</strong>
                <div style="font-size:0.9em;color:#64748b;margin-top:6px;">
                    Resume from latest in-game save
                </div>
            `;
            options.appendChild(main);
            selectedSave = null;

            // Save states
            if (game.save_states?.length > 0) {
                game.save_states.forEach(state => {
                    const opt = document.createElement('div');
                    opt.className = 'save-option';
                    opt.onclick = () => selectSave(state, opt);

                    const date = new Date(state.modified * 1000);
                    opt.innerHTML = `
                        <strong>‚ö° ${state.filename}</strong>
                        <div style="font-size:0.9em;color:#64748b;margin-top:6px;">
                            ${date.toLocaleString()}
                        </div>
                    `;
                    options.appendChild(opt);
                });
            }

            document.getElementById('launchModal').classList.add('active');
        }

        function selectSave(saveState, element) {
            document.querySelectorAll('.save-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedSave = saveState;
        }

        function closeLaunchModal() {
            document.getElementById('launchModal').classList.remove('active');
            currentGame = null;
            selectedSave = null;
        }

        async function confirmLaunch() {
            if (!currentGame) return;

            const gameId = currentGame.disc_id || currentGame.id || 'unknown';

            try {
                const res = await fetch(`${API_BASE}/launch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        disc_id: gameId,
                        save_state: selectedSave?.path || null
                    })
                });

                const result = await res.json();

                if (result.success) {
                    alert(`Launching ${currentGame.title || 'game'}!`);
                    closeLaunchModal();
                } else {
                    alert(`Error: ${result.error || 'Unknown error'}`);
                }
            } catch (e) {
                alert(`Launch failed: ${e.message}`);
            }
        }

        // Auto refresh when online
        setInterval(() => {
            if (document.getElementById('localAgentStatus').textContent.includes('Online')) {
                loadGames(currentTab);
            }
        }, 30000);

        // Start
        checkAgentStatus();
		// Make sure to call loadGames for all tabs on startup
		document.addEventListener('DOMContentLoaded', () => {
			console.log('[INIT] Loading all games on startup');
			checkAgentStatus();
			loadGames('all');
			loadGames('ppsspp');
			loadGames('snes9x');
		});
				
    </script>
</body>
</html>